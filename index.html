<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Village Tycoon 3D - GitHub Pages</title>
<style>
body { margin:0; overflow:hidden; font-family:Arial; background:#87ceeb; } /* ciel bleu */
#ui { position:absolute; top:10px; left:10px; color:white; z-index:10; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px;}
#nextBlock { font-weight:bold; margin-bottom:5px; }
button { padding:5px 10px; display:block; margin-top:5px; cursor:pointer; }
#minimap { position:absolute; top:10px; right:10px; width:150px; height:150px; border:2px solid white; background:#228B22; z-index:10;} /* herbe verte */
</style>
</head>
<body>
<div id="ui">
  Argent: <span id="money">200</span><br>
  <div id="nextBlock"></div>
  <button id="buildBtn">Construire l'étage</button>
</div>
<canvas id="minimap"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<script>
// --- Scène ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb); // ciel bleu

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(20,20,20);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.update();

// Lumières
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dirLight = new THREE.DirectionalLight(0xffffff,1);
dirLight.position.set(20,30,20);
scene.add(dirLight);

// Sol (herbe verte)
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x228B22})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// --- Variables ---
let money = 200;
document.getElementById('money').textContent = money;

const buildings = [
  {type:'Maison', x:0, z:0, floors:3, cost:50, income:1, color:0x00ff00, roofColor:0x8B0000, height:0},
  {type:'Ferme', x:5, z:0, floors:2, cost:75, income:2, color:0xffff00, roofColor:0xA0522D, height:0}
];

let currentBuilding = 0;
const placedBlocks = [];

// --- UI ---
function updateNextBlock(){
  if(currentBuilding >= buildings.length){
    document.getElementById('nextBlock').textContent = "Tous les bâtiments construits !";
    document.getElementById('buildBtn').disabled = true;
    return;
  }
  const b = buildings[currentBuilding];
  document.getElementById('nextBlock').textContent = 
    `Prochain étage: ${b.type} (${b.height+1}/${b.floors}) - ${b.cost}$`;
}

// --- Construction étage ---
function buildFloor(){
  console.log("buildFloor appelé"); // debug
  if(currentBuilding >= buildings.length) return;
  const b = buildings[currentBuilding];

  if(money < b.cost){
    alert("Pas assez d'argent !");
    return;
  }

  money -= b.cost;
  document.getElementById('money').textContent = money;

  // Bloc unique par étage
  const cube = new THREE.Mesh(
    new THREE.BoxGeometry(2,2,2),
    new THREE.MeshStandardMaterial({color:b.color})
  );
  cube.position.set(b.x, b.height*2 +1, b.z);
  scene.add(cube);
  placedBlocks.push(cube);

  b.height++;

  // Toit si dernier étage
  if(b.height === b.floors){
    const roof = new THREE.Mesh(
      new THREE.ConeGeometry(1.5,1.5,4),
      new THREE.MeshStandardMaterial({color:b.roofColor})
    );
    roof.position.set(b.x, b.height*2 +0.75, b.z);
    roof.rotation.y = Math.PI/4;
    scene.add(roof);
    currentBuilding++;
  }

  updateNextBlock();
}

// --- Revenu automatique ---
setInterval(()=>{
  buildings.forEach(b => money += b.height * b.income);
  document.getElementById('money').textContent = Math.floor(money);
},1000);

// --- Animation ---
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}
animate();

// --- Mini-carte ---
const miniCanvas = document.getElementById('minimap');
const miniCtx = miniCanvas.getContext('2d');

function updateMinimap(){
  miniCtx.clearRect(0,0,150,150);
  miniCtx.fillStyle = "#228B22"; // herbe
  miniCtx.fillRect(0,0,150,150);

  placedBlocks.forEach(b => {
    const mx = 75 + b.position.x*5;
    const mz = 75 + b.position.z*5;
    miniCtx.fillStyle = "white";
    miniCtx.fillRect(mx-1, mz-1, 2, 2);
  });
}

// --- Bouton mobile/desktop ---
const btn = document.getElementById('buildBtn');
let touchHandled = false;

btn.addEventListener('touchstart', (e)=>{
  if(!touchHandled){ buildFloor(); touchHandled = true; }
});
btn.addEventListener('click', (e)=>{
  if(!touchHandled){ buildFloor(); }
  touchHandled = false;
});

// --- Initialisation ---
updateNextBlock();
</script>
</body>
</html>
