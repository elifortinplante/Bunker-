<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Bunker Tycoon 3D - Version Avancée</title>
<style>
body { margin:0; overflow:hidden; background:#222; font-family:Arial; }
#ui { position:absolute; top:10px; left:10px; color:white; }
#nextBlock { margin-bottom:10px; font-weight:bold; }
button { padding:5px 10px; margin-top:5px; display:block; }
</style>
</head>
<body>
<div id="ui">
  Argent: <span id="money">200</span><br>
  <div id="nextBlock">Prochain bloc: Dortoir</div>
  <button onclick="placeBlock()">Poser le bloc</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
// --- Scène 3D ---
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x333333);

let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(15,20,25);
camera.lookAt(0,0,0);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lumière
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(20,20,20);
scene.add(light);
scene.add(new THREE.AmbientLight(0x555555));

// Sol
let ground = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x444444})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// --- Variables jeu ---
let money = 200;
document.getElementById('money').textContent = money;

// Définition des blocs prédéfinis avec types, coûts, revenus et positions
let predefinedBlocks = [
  {type:'Dortoir', position:{x:0,y:1,z:0}, cost:50, income:1, color:0x00ff00, level:1},
  {type:'Atelier', position:{x:0,y:1,z:3}, cost:100, income:2, color:0xffff00, level:1},
  {type:'Réservoir', position:{x:3,y:1,z:0}, cost:75, income:1.5, color:0x00ffff, level:1},
  {type:'Dortoir', position:{x:3,y:1,z:3}, cost:50, income:1, color:0x00ff00, level:1},
  {type:'Atelier', position:{x:6,y:1,z:0}, cost:100, income:2, color:0xffff00, level:1},
  {type:'Réservoir', position:{x:6,y:1,z:3}, cost:75, income:1.5, color:0x00ffff, level:1},
];

let currentBlockIndex = 0;
let buildings = [];

// Affichage bloc suivant
function updateNextBlock(){
  if(currentBlockIndex < predefinedBlocks.length){
    document.getElementById('nextBlock').textContent = 'Prochain bloc: ' + predefinedBlocks[currentBlockIndex].type;
  } else {
    document.getElementById('nextBlock').textContent = 'Tous les blocs posés !';
  }
}

// Poser bloc
function placeBlock(){
  if(currentBlockIndex >= predefinedBlocks.length) return;
  let block = predefinedBlocks[currentBlockIndex];

  if(money < block.cost){
    alert("Pas assez d'argent !");
    return;
  }

  money -= block.cost;
  updateMoney();

  // Création bloc 3D
  let geometry = new THREE.BoxGeometry(2,2,2);
  let material = new THREE.MeshStandardMaterial({color:block.color});
  let cube = new THREE.Mesh(geometry, material);
  cube.position.set(block.position.x,1,block.position.z);
  cube.scale.set(0.1,0.1,0.1);
  scene.add(cube);

  // Animation simple de construction
  let scale = 0.1;
  let anim = setInterval(()=>{
    scale += 0.05;
    cube.scale.set(scale, scale, scale);
    if(scale >= 1) clearInterval(anim);
  },30);

  buildings.push({...block, mesh:cube});
  currentBlockIndex++;
  updateNextBlock();
}

// Upgrade bâtiment
function upgrade(building){
  let upgradeCost = building.level*50;
  if(money < upgradeCost){
    alert("Pas assez d'argent pour upgrader !");
    return;
  }
  money -= upgradeCost;
  building.level++;
  building.income *= 1.5; // augmente revenu
  updateMoney();

  // Animation upgrade (tremblement)
  let originalY = building.mesh.position.y;
  let count = 0;
  let anim = setInterval(()=>{
    building.mesh.position.y = originalY + Math.sin(count*Math.PI/4)*0.2;
    count++;
    if(count>8){
      building.mesh.position.y = originalY;
      clearInterval(anim);
    }
  },30);
}

// Affichage argent
function updateMoney(){
  document.getElementById('money').textContent = Math.floor(money);
}

// Génération automatique d'argent
function generateMoney(){
  buildings.forEach(b=>{
    money += b.income;
  });
  updateMoney();
  randomEvent();
}
setInterval(generateMoney,1000);

// Événements aléatoires
function randomEvent(){
  if(Math.random()<0.01 && buildings.length>0){
    let bonus = Math.floor(Math.random()*50+10);
    money += bonus;
    updateMoney();
    alert("Événement bonus ! Tu gagnes "+bonus+"$");
  }
}

// Boucle animation
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene,camera);
}
animate();

// Upgrade au clic sur bâtiment
window.addEventListener('click', (e)=>{
  let mouse = new THREE.Vector2();
  mouse.x = (e.clientX/window.innerWidth)*2-1;
  mouse.y = -(e.clientY/window.innerHeight)*2+1;

  let raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse,camera);
  let intersects = raycaster.intersectObjects(buildings.map(b=>b.mesh));
  if(intersects.length>0){
    let b = buildings.find(b=>b.mesh===intersects[0].object);
    upgrade(b);
  }
});
</script>
</body>
</html>
