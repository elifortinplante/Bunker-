<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Bunker Tycoon 3D</title>
<style>
body { margin:0; overflow:hidden; background:#222; font-family:Arial; }
#ui { position:absolute; top:10px; left:10px; color:white; }
button { margin:5px; padding:5px 10px; }
</style>
</head>
<body>
<div id="ui">
  Argent: <span id="money">100</span><br>
  <button onclick="build('dortoir')">Construire Dortoir (50$)</button>
  <button onclick="build('atelier')">Construire Atelier (100$)</button>
  <button onclick="build('reservoir')">Construire Réservoir (75$)</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<script>
// --- Scène ---
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x333333);

let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(10,15,20);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Contrôle caméra
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.update();

// Lumières
let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(20,20,20);
scene.add(light);
scene.add(new THREE.AmbientLight(0x555555));

// Sol
let ground = new THREE.Mesh(
  new THREE.PlaneGeometry(50,50),
  new THREE.MeshStandardMaterial({color:0x444444})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// Variables du jeu
let money = 100;
let buildings = [];
let positions = {dortoir:{x:0,z:0}, atelier:{x:5,z:0}, reservoir:{x:10,z:0}};

// --- Fonction construction étage (1 bloc = 1 étage) ---
function build(type){
  let cost=0,color=0x00ff00,height=0;
  if(type==='dortoir'){ cost=50;color=0x00ff00; }
  if(type==='atelier'){ cost=100;color=0xffff00; }
  if(type==='reservoir'){ cost=75;color=0x00ffff; }
  if(money<cost) return alert("Pas assez d'argent !");
  money-=cost;
  updateMoney();

  // Vérifie si bâtiment existe déjà
  let building = buildings.find(b=>b.type===type);
  if(!building){
    building = {type:type, level:0, mesh:null};
    buildings.push(building);
  }

  // Place le bloc (1 étage)
  height = building.level;
  let cube = new THREE.Mesh(
    new THREE.BoxGeometry(2,2,2),
    new THREE.MeshStandardMaterial({color:color})
  );
  cube.position.set(positions[type].x,1 + height*2, positions[type].z);
  scene.add(cube);
  building.mesh = cube;
  building.level++;

  // Toit si dernier étage (exemple max 3 étages)
  if(building.level === 3){
    let roof = new THREE.Mesh(
      new THREE.ConeGeometry(1.5,1.5,4),
      new THREE.MeshStandardMaterial({color:0x8B0000})
    );
    roof.position.set(positions[type].x,1 + building.level*2, positions[type].z);
    roof.rotation.y = Math.PI/4;
    scene.add(roof);
  }

  // Animation simple
  cube.scale.set(0.1,0.1,0.1);
  let scale=0.1;
  let anim=setInterval(()=>{
    scale+=0.05;
    cube.scale.set(scale,scale,scale);
    if(scale>=1) clearInterval(anim);
  },30);
}

// --- Génération automatique d'argent ---
function generateMoney(){
  buildings.forEach(b=>{
    if(b.type==='dortoir') money += b.level*1;
    if(b.type==='atelier') money += b.level*2;
    if(b.type==='reservoir') money += b.level*1.5;
  });
  updateMoney();
  randomEvent();
}

// --- Mettre à jour affichage argent ---
function updateMoney(){
  document.getElementById('money').textContent = Math.floor(money);
}

// --- Événements aléatoires ---
function randomEvent(){
  if(Math.random()<0.01){
    let bonus = Math.floor(Math.random()*50+10);
    money += bonus;
    updateMoney();
    alert("Événement bonus ! Tu gagnes "+bonus+"$");
  }
}

// --- Boucle jeu ---
setInterval(generateMoney,1000);

// --- Animation ---
function animate(){
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene,camera);
}
animate();

// --- Upgrade au clic (monte d’un étage supplémentaire) ---
window.addEventListener('click',(e)=>{
  let mouse = new THREE.Vector2();
  mouse.x = (e.clientX/window.innerWidth)*2-1;
  mouse.y = -(e.clientY/window.innerHeight)*2+1;

  let raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse,camera);
  let intersects = raycaster.intersectObjects(buildings.map(b=>b.mesh));
  if(intersects.length>0){
    let b = buildings.find(b=>b.mesh===intersects[0].object);
    build(b.type); // ajoute un étage
  }
});
</script>
</body>
</html>
